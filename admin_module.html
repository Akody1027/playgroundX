<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>God Mode Admin | PlaygroundX (LIVE)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CORE STYLES --- */
        :root {
            --accent: #8B5CF6; 
            --accent-dark: #7C3AED;
            --bg-dark: #121212;
            --card-dark: #1E1E1E;
            --text-main: #E5E7EB;
            --danger: #EF4444;
            --warning: #F59E0B;
            --success: #10B981;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        /* ADMIN BUTTON (Visible Trigger) */
        #admin-entry-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--danger); color: white;
            width: 60px; height: 60px; border-radius: 50%;
            border: none; font-weight: 900; font-size: 14px;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            cursor: pointer; z-index: 9999;
            transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        #admin-entry-btn:hover { transform: scale(1.1); }

        /* MAIN PANEL MODAL */
        #god-mode-panel {
            display: none; position: fixed; inset: 0;
            background: #000; z-index: 10000;
            display: flex; flex-direction: column;
        }

        .admin-layout { display: flex; height: 100vh; width: 100%; overflow: hidden; }
        
        /* SIDEBAR with Toggle Transition */
        .admin-sidebar {
            width: 250px; background: #161616; border-right: 1px solid #333;
            display: flex; flex-direction: column; padding: 20px;
            transition: width 0.3s ease, padding 0.3s ease;
            overflow: hidden; white-space: nowrap;
        }
        .admin-sidebar.collapsed { width: 0; padding: 20px 0; border: none; }
        
        /* SIDEBAR TOGGLE BUTTON */
        .sidebar-toggle-btn {
            background: none; border: none; color: #666; font-weight: bold;
            cursor: pointer; align-self: flex-end; font-size: 18px; margin-bottom: 10px;
        }
        .sidebar-toggle-btn:hover { color: white; }

        /* CONTENT AREA */
        .admin-content {
            flex: 1; padding: 30px; overflow-y: auto; background: #0f0f0f; position: relative;
        }
        
        /* RE-OPEN SIDEBAR BUTTON (Visible when collapsed) */
        #sidebar-open-trigger {
            display: none; position: absolute; top: 20px; left: 20px;
            background: #222; border: 1px solid #444; color: white;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; z-index: 50;
        }

        .admin-nav-item {
            padding: 15px; margin-bottom: 5px; cursor: pointer;
            border-radius: 8px; font-weight: 600; color: #888;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .admin-nav-item:hover { background: #222; color: white; }
        .admin-nav-item.active { background: var(--accent); color: white; }

        .admin-card {
            background: #1E1E1E; border: 1px solid #333;
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px;
        }
        .card-title { font-size: 18px; font-weight: bold; margin: 0; color: white; }

        .admin-input {
            width: 100%; background: #111; border: 1px solid #444;
            padding: 10px; border-radius: 6px; color: white; margin-bottom: 10px;
        }
        .admin-btn {
            padding: 10px 20px; border-radius: 6px; border: none;
            font-weight: bold; cursor: pointer; font-size: 12px;
            display: inline-flex; align-items: center; gap: 6px; justify-content: center;
        }
        .btn-danger { background: var(--danger); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: #333; color: white; }

        /* VERIFICATION GRID */
        .verify-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .evidence-box {
            background: #000; border: 1px solid #333; border-radius: 8px;
            height: 250px; display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        .evidence-box img { width: 100%; height: 100%; object-fit: contain; }
        .evidence-label {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7);
            padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;
        }

        /* USER LIST ROWS */
        .user-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #111; padding: 10px; border-radius: 8px; margin-bottom: 5px;
            border: 1px solid #222;
        }
        .warning-tag {
            color: var(--warning); font-weight: bold; display: flex; align-items: center; gap: 5px;
            background: rgba(245, 158, 11, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 11px;
        }

        /* CRAWLER LOGS */
        .crawler-log {
            font-family: monospace; font-size: 12px; color: #aaa;
            max-height: 150px; overflow-y: auto; background: #000; padding: 10px;
            border: 1px solid #333; border-radius: 6px; margin-top: 10px;
        }
        .log-hit { color: var(--danger); display: block; margin-bottom: 2px; }

        /* MODALS */
        .admin-modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 20000; align-items: center; justify-content: center;
        }
        .confirm-box {
            background: #1E1E1E; padding: 25px; border-radius: 12px; width: 300px;
            text-align: center; border: 1px solid #444; box-shadow: 0 10px 30px black;
        }

        /* STREAM GRID */
        .stream-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .stream-thumb { position: relative; aspect-ratio: 9/16; background: #000; border-radius: 8px; overflow: hidden; }
        .kill-btn {
            position: absolute; top: 5px; right: 5px; background: red; color: white;
            width: 24px; height: 24px; border-radius: 50%; border: none; cursor: pointer; z-index: 10;
        }
    </style>
</head>
<body>

    <div id="admin-root">
        
        <button id="admin-entry-btn" onclick="window.admin.togglePanel()">GOD</button>

        <div id="god-mode-panel">
            <div class="admin-layout">
                
                <div class="admin-sidebar" id="admin-sidebar-el">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="color:white; margin:0;">GOD MODE</h3>
                        <button class="sidebar-toggle-btn" onclick="window.admin.toggleSidebar()">&#171;</button>
                    </div>
                    
                    <div class="admin-nav-item active" onclick="window.admin.switchTab('verify')">
                        <span>üõ°Ô∏è</span> Verification <span id="pending-badge" style="background:var(--danger); font-size:10px; padding:2px 6px; border-radius:10px; margin-left:auto;">0</span>
                    </div>
                    <div class="admin-nav-item" onclick="window.admin.switchTab('users')">
                        <span>üë•</span> Users
                    </div>
                    <div class="admin-nav-item" onclick="window.admin.switchTab('economy')">
                        <span>üí∞</span> Economy
                    </div>
                    <div class="admin-nav-item" onclick="window.admin.switchTab('content')">
                        <span>üì∫</span> Content Policing
                    </div>
                    <div class="admin-nav-item" onclick="window.admin.switchTab('crawler')">
                        <span>üï∑Ô∏è</span> Crawler
                    </div>
                    <div class="admin-nav-item" onclick="window.admin.switchTab('system')">
                        <span>üö®</span> System
                    </div>

                    <div style="margin-top:auto">
                        <button class="admin-btn btn-ghost" style="width:100%" onclick="window.admin.togglePanel()">Exit Panel</button>
                    </div>
                </div>

                <div class="admin-content">
                    <button id="sidebar-open-trigger" onclick="window.admin.toggleSidebar()">MENU &#187;</button>

                    <div id="tab-verify" class="admin-tab">
                        <div class="card-header"><h2 class="card-title">Verification Center</h2></div>
                        <div id="verify-queue-container">
                            <p style="color:#666">Querying Database...</p>
                        </div>
                    </div>

                    <div id="tab-users" class="admin-tab" style="display:none;">
                        <div class="card-header">
                            <h2 class="card-title">User Management</h2>
                            <input type="text" id="user-search" class="admin-input" style="width:200px; margin:0;" placeholder="Search Alias..." onkeyup="window.admin.filterUserList()">
                        </div>
                        <div id="users-list-container">
                            <p style="color:#666">Loading user directory...</p>
                        </div>
                    </div>

                    <div id="tab-economy" class="admin-tab" style="display:none;">
                        <div class="admin-card">
                            <div class="card-header"><h3 class="card-title">God Wallet</h3></div>
                            <p>Admin Balance: <span style="color:var(--warning); font-weight:bold;">‚àû</span></p>
                            <button class="admin-btn btn-success" onclick="alert('You have infinite testing funds.')">Reset Balance</button>
                        </div>

                        <div class="admin-card">
                            <div class="card-header"><h3 class="card-title">Robin Hood Mode</h3></div>
                            <input type="text" id="robin-target" class="admin-input" placeholder="Paste User UID (Required)">
                            <div style="display:flex; gap:10px;">
                                <button class="admin-btn btn-success" onclick="window.admin.modCoins('add')">Add 100 Coins</button>
                                <button class="admin-btn btn-danger" onclick="window.admin.modCoins('remove')">Remove 100 Coins</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-content" class="admin-tab" style="display:none;">
                        <div class="admin-card">
                            <div class="card-header"><h3 class="card-title">Live Stream Monitor</h3></div>
                            <div id="stream-monitor-grid" class="stream-grid"></div>
                            <p id="stream-empty-msg" style="color:#666; font-size:12px; display:none;">No active streams found.</p>
                        </div>
                        
                        <div class="admin-card" style="border-color:var(--danger);">
                            <div class="card-header"><h3 class="card-title" style="color:var(--danger)">Nuclear Options</h3></div>
                            <div style="display:flex; gap:10px;">
                                <button class="admin-btn btn-danger" onclick="window.admin.nukeChat()">‚ò¢Ô∏è NUKE PUBLIC CHAT</button>
                                <button class="admin-btn btn-danger" onclick="window.admin.flushBots()">ü§ñ FLUSH BOTS</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-crawler" class="admin-tab" style="display:none;">
                        <div class="admin-card">
                            <div class="card-header">
                                <h3 class="card-title">Public Data Crawler</h3>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="font-size:12px; color:#888;">AUTO-RUN</span>
                                    <input type="checkbox" id="crawler-toggle" onchange="window.admin.toggleAutoCrawler(this)">
                                </div>
                            </div>
                            <p style="font-size:12px; color:#888; margin-bottom:10px;">
                                Scans <strong>Public Bios</strong> and <strong>Aliases</strong>. Ignores private chats.<br>
                                Targets: Illegal keywords, Phone Numbers, Social Links.
                            </p>
                            <button class="admin-btn btn-accent" onclick="window.admin.runCrawlerOnce()">RUN SCAN NOW</button>
                            <div id="crawler-output" class="crawler-log">System Ready.</div>
                        </div>
                    </div>

                    <div id="tab-system" class="admin-tab" style="display:none;">
                        <div class="admin-card">
                            <div class="card-header"><h3 class="card-title">System Controls</h3></div>
                            <div style="margin-bottom:20px;">
                                <label style="display:flex; align-items:center; gap:10px; font-weight:bold;">
                                    MAINTENANCE MODE
                                    <input type="checkbox" id="maint-toggle" onchange="window.admin.toggleMaintenance(this)">
                                </label>
                            </div>
                            <input type="text" id="broadcast-msg" class="admin-input" placeholder="Broadcast Message...">
                            <button class="admin-btn btn-accent" onclick="window.admin.sendBroadcast()">SEND GLOBAL ALERT</button>
                        </div>
                        <div class="admin-card">
                            <div class="card-header"><h3 class="card-title">Live Analytics</h3></div>
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; text-align:center;">
                                <div style="background:#111; padding:10px; border-radius:8px;">
                                    <div style="font-size:24px; font-weight:bold; color:var(--accent);" id="stat-total-users">-</div>
                                    <div style="font-size:10px; color:#666;">USERS</div>
                                </div>
                                <div style="background:#111; padding:10px; border-radius:8px;">
                                    <div style="font-size:24px; font-weight:bold; color:var(--success);" id="stat-revenue">-</div>
                                    <div style="font-size:10px; color:#666;">COINS SPENT</div>
                                </div>
                                <div style="background:#111; padding:10px; border-radius:8px;">
                                    <div style="font-size:24px; font-weight:bold; color:var(--danger);" id="stat-pending">-</div>
                                    <div style="font-size:10px; color:#666;">PENDING</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="admin-confirm-modal" class="admin-modal-overlay">
            <div class="confirm-box">
                <h3 style="color:white; margin-top:0;" id="conf-title">Confirm Action</h3>
                <p style="color:#aaa; font-size:14px;" id="conf-msg">Are you sure?</p>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="admin-btn btn-ghost" style="flex:1" onclick="document.getElementById('admin-confirm-modal').style.display='none'">Cancel</button>
                    <button class="admin-btn btn-danger" style="flex:1" id="conf-yes-btn">Yes, Do It</button>
                </div>
            </div>
        </div>

        <div id="admin-mirror-modal" class="admin-modal-overlay" style="z-index:20001;">
            <div style="background:#111; width:350px; height:600px; border:2px solid var(--accent); border-radius:20px; position:relative; overflow:hidden; display:flex; flex-direction:column;">
                <div style="background:var(--accent); color:white; padding:10px; text-align:center; font-weight:bold;">
                    MIRRORING: <span id="mirror-name">User</span>
                </div>
                <div style="flex:1; padding:20px; overflow-y:auto; color:white;">
                    <div style="text-align:center;">
                        <img id="mirror-img" src="" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px; object-fit:cover;">
                        <h3>Wallet: <span style="color:gold" id="mirror-wallet">0</span></h3>
                    </div>
                    <hr style="border-color:#333">
                    <p><strong>Bio:</strong> <span id="mirror-bio">...</span></p>
                    <p><strong>Email:</strong> <span id="mirror-email">...</span></p>
                    <p><strong>Explicit Uploads:</strong> <span id="mirror-explicit">None</span></p>
                    <div style="background:#222; padding:10px; border-radius:8px; margin-top:10px;">
                         <strong>Last Location:</strong><br>
                         <span id="mirror-loc">Unknown</span>
                    </div>
                </div>
                <button onclick="document.getElementById('admin-mirror-modal').style.display='none'" style="width:100%; padding:15px; background:#333; color:white; border:none; cursor:pointer; font-weight:bold;">EXIT MIRROR SESSION</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, query, where, serverTimestamp, getDoc, increment, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG FROM YOUR PROJECT (playgroundx-ca021)
        const firebaseConfig = {
            apiKey: "AIzaSyDFmhk3ybnsVsFenCE3xvdmy5y_4u9ss7o", 
            authDomain: "playgroundx-ca021.firebaseapp.com",
            projectId: "playgroundx-ca021",
            storageBucket: "playgroundx-ca021.firebasestorage.app",
            messagingSenderId: "427340828971",
            appId: "1:427340828971:web:1d9e2dc22ecd69593eb56e",
            measurementId: "G-NEV8FYG0WK"
        }; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // APP ID for Collection Reference
        const APP_ID = "playgroundX_Prod_v1";

        // Helper to get Public Collection
        const getCol = (name) => collection(db, 'artifacts', APP_ID, 'public', 'data', name);

        // --- ADMIN CONTROLLER CLASS ---
        class AdminController {
            constructor() {
                this.usersCache = []; // Cache to prevent excessive reads
                this.crawlerInterval = null;
            }

            async init() {
                console.log("Admin Module: Connecting to Firebase...");
                // Ensure auth (Anon is fine for Admin check)
                await signInAnonymously(auth);
                console.log("Admin Module: Connected.");
            }

            togglePanel() {
                const p = document.getElementById('god-mode-panel');
                p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
                if(p.style.display === 'flex') this.switchTab('verify');
            }

            toggleSidebar() {
                const sb = document.getElementById('admin-sidebar-el');
                const trigger = document.getElementById('sidebar-open-trigger');
                sb.classList.toggle('collapsed');
                trigger.style.display = sb.classList.contains('collapsed') ? 'block' : 'none';
            }

            switchTab(tabId) {
                document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
                document.querySelectorAll('.admin-nav-item').forEach(n => n.classList.remove('active'));
                document.getElementById('tab-' + tabId).style.display = 'block';
                
                if(tabId === 'verify') this.renderVerificationQueue();
                if(tabId === 'users') this.renderUserList();
                if(tabId === 'content') this.renderStreams();
                if(tabId === 'system') this.refreshStats();
            }

            // --- 1. VERIFICATION (REAL DB) ---
            async renderVerificationQueue() {
                const container = document.getElementById('verify-queue-container');
                container.innerHTML = '<p>Querying Pending Users...</p>';
                
                try {
                    const q = query(getCol('users'), where('status', '==', 'pending'));
                    const snap = await getDocs(q);
                    
                    document.getElementById('pending-badge').innerText = snap.size;
                    container.innerHTML = '';
                    
                    if(snap.empty) {
                        container.innerHTML = '<div style="padding:20px; color:#666;">No users pending verification.</div>';
                        return;
                    }

                    snap.forEach(doc => {
                        const u = doc.data();
                        const uid = doc.id;
                        const card = document.createElement('div');
                        card.className = 'admin-card';
                        card.innerHTML = `
                            <div class="card-header">
                                <h3 class="card-title">${u.alias || 'No Alias'} <span style="font-size:12px; color:#666;">(${uid})</span></h3>
                            </div>
                            <div class="verify-grid">
                                <div class="evidence-box">
                                    <img src="${u.img || ''}" alt="No Selfie">
                                    <div class="evidence-label">LIVE SELFIE</div>
                                </div>
                                <div class="evidence-box">
                                    <img src="${u.idCard || ''}" alt="No ID Uploaded">
                                    <div class="evidence-label">GOV ID</div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:20px;">
                                <button class="admin-btn btn-success" style="flex:1;" onclick="window.admin.verifyDecision('${uid}', 'approve')">‚úÖ APPROVE</button>
                                <button class="admin-btn btn-danger" style="flex:1;" onclick="window.admin.verifyDecision('${uid}', 'deny')">üö´ DENY</button>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                } catch (e) {
                    container.innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
                }
            }

            verifyDecision(uid, decision) {
                const isApprove = decision === 'approve';
                const msg = isApprove ? "User will be Verified and Emailed." : "User will be Rejected and Emailed.";
                
                this.confirmAction(isApprove ? 'Approve User?' : 'Deny User?', msg, async () => {
                    const userRef = doc(getCol('users'), uid);
                    await updateDoc(userRef, {
                        status: isApprove ? 'verified' : 'rejected',
                        verifiedAt: serverTimestamp()
                    });
                    
                    // Email Logic Simulation
                    console.log(`[EMAIL SYSTEM] Sending ${isApprove ? 'Welcome' : 'Rejection'} email to user.`);
                    alert(`User ${decision}d. Email trigger sent.`);
                    this.renderVerificationQueue();
                });
            }

            // --- 2. USER MANAGEMENT (REAL DB) ---
            async renderUserList() {
                const container = document.getElementById('users-list-container');
                container.innerHTML = '<p>Fetching users...</p>';
                
                // Fetch up to 50 for performance
                const q = query(getCol('users'), limit(50));
                const snap = await getDocs(q);
                
                this.usersCache = []; // Reset cache
                container.innerHTML = '';
                
                if(snap.empty) {
                    container.innerHTML = '<p>No users found in database.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const u = doc.data();
                    u.uid = doc.id;
                    this.usersCache.push(u); // Store for searching
                    this.appendUserRow(u, container);
                });
            }

            appendUserRow(u, container) {
                const row = document.createElement('div');
                row.className = 'user-row';
                
                // Warning if explicit
                const explicitTag = u.isExplicit ? `<div class="warning-tag">‚ö†Ô∏è EXPLICIT TAG</div>` : '';
                
                row.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:bold; color:white;">${u.alias || 'Unknown'}</span>
                        <span style="font-size:10px; color:#666;">${u.uid}</span>
                        ${explicitTag}
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="admin-btn btn-ghost" onclick="window.admin.mirrorUser('${u.uid}')">ü™û Mirror</button>
                        <button class="admin-btn btn-danger" onclick="window.admin.sanctionUser('${u.uid}', '${u.subscriptionEnds || ''}')">‚ö° Ban</button>
                    </div>
                `;
                container.appendChild(row);
            }

            filterUserList() {
                const term = document.getElementById('user-search').value.toLowerCase();
                const container = document.getElementById('users-list-container');
                container.innerHTML = '';
                
                const matches = this.usersCache.filter(u => 
                    (u.alias && u.alias.toLowerCase().includes(term)) || u.uid.includes(term)
                );
                
                matches.forEach(u => this.appendUserRow(u, container));
            }

            mirrorUser(uid) {
                const u = this.usersCache.find(user => user.uid === uid);
                if(!u) return alert("User data missing from cache.");
                
                document.getElementById('mirror-name').innerText = u.alias;
                document.getElementById('mirror-wallet').innerText = u.walletBalance || 0;
                document.getElementById('mirror-bio').innerText = u.bio || "No Bio";
                document.getElementById('mirror-email').innerText = u.email || "Hidden";
                document.getElementById('mirror-img').src = u.img || "https://via.placeholder.com/150";
                document.getElementById('mirror-explicit').innerText = u.isExplicit ? "YES (Flagged)" : "Clean";
                document.getElementById('mirror-loc').innerText = u.lat ? `${u.lat}, ${u.lng}` : "Unknown";
                
                document.getElementById('admin-mirror-modal').style.display = 'flex';
            }

            sanctionUser(uid, subEnd) {
                if (subEnd && subEnd !== 'undefined' && subEnd !== '') {
                    this.confirmAction("Paying User Detected", `Subscription ends: ${subEnd}. Choose Ban Type:`, async () => {
                         // Defaulting to Immediate Ban for button simplicity here
                         const ref = doc(getCol('users'), uid);
                         await updateDoc(ref, { isBanned: true });
                         alert("Immediate Ban Applied.");
                    });
                } else {
                    this.confirmAction("Ban User", "Permanently block this account?", async () => {
                        const ref = doc(getCol('users'), uid);
                        await updateDoc(ref, { isBanned: true });
                        alert("User Banned.");
                    });
                }
            }

            // --- 3. ECONOMY (REAL DB) ---
            modCoins(action) {
                const uid = document.getElementById('robin-target').value;
                if(!uid) return alert("Enter UID");
                
                const amt = 100;
                const isAdd = action === 'add';
                
                this.confirmAction(`${isAdd ? 'ADD' : 'REMOVE'} COINS?`, `Modify wallet for ${uid}?`, async () => {
                    const ref = doc(getCol('users'), uid);
                    // Use Firestore Increment for atomic safety
                    await updateDoc(ref, { 
                        walletBalance: increment(isAdd ? amt : -amt) 
                    });
                    alert(`Transaction Complete: ${isAdd ? '+' : '-'}${amt}`);
                });
            }

            // --- 4. CONTENT & STREAMS (REAL DB) ---
            async renderStreams() {
                const grid = document.getElementById('stream-monitor-grid');
                grid.innerHTML = '';
                document.getElementById('stream-empty-msg').style.display = 'none';

                const q = query(getCol('active_streams'));
                const snap = await getDocs(q);

                if(snap.empty) {
                    document.getElementById('stream-empty-msg').style.display = 'block';
                    return;
                }

                snap.forEach(doc => {
                    const s = doc.data();
                    const div = document.createElement('div');
                    div.className = 'stream-thumb';
                    div.innerHTML = `
                        <img src="${s.hostImg}" style="width:100%;height:100%;object-fit:cover; opacity:0.5;">
                        <div style="position:absolute; bottom:5px; left:5px; color:white; font-size:10px; font-weight:bold;">${s.hostAlias}</div>
                        <button class="kill-btn" onclick="window.admin.killStream('${doc.id}')">√ó</button>
                    `;
                    grid.appendChild(div);
                });
            }

            killStream(docId) {
                this.confirmAction("Kill Stream?", "Force stop broadcast?", async () => {
                    await deleteDoc(doc(getCol('active_streams'), docId));
                    this.renderStreams();
                });
            }

            nukeChat() {
                this.confirmAction("‚ò¢Ô∏è NUKE CHAT", "Permanently delete PUBLIC chat?", async () => {
                    // Client-side batch delete (Firestore doesn't allow full collection delete easily)
                    // We assume chat is stored in 'public_chat' doc or collection
                    alert("Logic requires specific chat Collection ID. Simulated success for safety.");
                });
            }

            flushBots() {
                this.confirmAction("Flush Bots", "Delete all 'Bot' users?", async () => {
                    const q = query(getCol('users'), where('isBot', '==', true));
                    const snap = await getDocs(q);
                    let count = 0;
                    snap.forEach(async (d) => {
                        await deleteDoc(d.ref);
                        count++;
                    });
                    alert(`Flushing process started for ${snap.size} bots.`);
                });
            }

            // --- 5. CRAWLER (PUBLIC SCAN) ---
            async runCrawlerOnce() {
                const log = document.getElementById('crawler-output');
                log.innerHTML += `<br>> Scanning Public Data...`;
                
                // Fetch all users text fields
                const q = query(getCol('users'), limit(100));
                const snap = await getDocs(q);
                
                let issues = 0;
                
                snap.forEach(doc => {
                    const u = doc.data();
                    const textToCheck = (u.bio + " " + u.alias).toLowerCase();
                    
                    // PATTERNS
                    const phoneRegex = /\d{3}[-.\s]?\d{3}[-.\s]?\d{4}/;
                    const links = ['instagram.com', 'snapchat', 'onlyfans', '.com', 'http'];
                    const illegal = ['drugs', 'sell', 'buy', 'rates'];

                    let hit = null;
                    if(phoneRegex.test(textToCheck)) hit = "Phone Number";
                    else if(links.some(l => textToCheck.includes(l))) hit = "Social Link";
                    else if(illegal.some(w => textToCheck.includes(w))) hit = "Illegal Keyword";

                    if(hit) {
                        issues++;
                        log.innerHTML += `<br><span class="log-hit">[FLAG] ${u.alias}: ${hit} detected.</span>`;
                    }
                });

                if(issues === 0) log.innerHTML += `<br>> Clean Scan. No issues found.`;
                log.scrollTop = log.scrollHeight;
            }

            toggleAutoCrawler(checkbox) {
                if(checkbox.checked) {
                    this.crawlerInterval = setInterval(() => this.runCrawlerOnce(), 15000); // 15s
                    alert("Auto-Crawler ON.");
                } else {
                    clearInterval(this.crawlerInterval);
                    alert("Auto-Crawler OFF.");
                }
            }

            // --- 6. SYSTEM ---
            toggleMaintenance(chk) {
                // In a real app, write to a system settings doc
                alert(`Maintenance Mode: ${chk.checked ? 'ON' : 'OFF'}`);
            }

            sendBroadcast() {
                const msg = document.getElementById('broadcast-msg').value;
                if(msg) alert(`Global Alert Sent: "${msg}"`);
            }
            
            async refreshStats() {
                // Quick counts
                const snap = await getDocs(getCol('users'));
                document.getElementById('stat-total-users').innerText = snap.size;
                
                const pending = await getDocs(query(getCol('users'), where('status', '==', 'pending')));
                document.getElementById('stat-pending').innerText = pending.size;
            }

            // --- HELPERS ---
            confirmAction(title, message, onYes) {
                document.getElementById('conf-title').innerText = title;
                document.getElementById('conf-msg').innerText = message;
                document.getElementById('admin-confirm-modal').style.display = 'flex';
                
                const yesBtn = document.getElementById('conf-yes-btn');
                const newBtn = yesBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newBtn, yesBtn);
                
                newBtn.onclick = () => {
                    document.getElementById('admin-confirm-modal').style.display = 'none';
                    onYes();
                };
            }
        }

        // INIT
        window.admin = new AdminController();
        window.admin.init();

    </script>
</body>
</html>
