<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Date | Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent: #8B5CF6; --danger: #EF4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: white; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }

        /* VIDEO LAYER */
        #stage { position: relative; width: 100%; height: 100%; background: #111; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video-container {
            position: absolute; top: 80px; right: 20px; width: 100px; height: 140px;
            background: #000; border-radius: 12px; overflow: hidden; border: 2px solid #333; z-index: 10;
        }
        #local-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* HUD */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            display: flex; justify-content: space-between; align-items: center; z-index: 20;
        }
        .timer-main { font-size: 28px; font-weight: 900; color: white; text-shadow: 0 2px 10px black; }
        .timer-main.urgent { color: var(--danger); animation: pulse 1s infinite; }
        
        .hud-bottom {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 30px 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex; justify-content: center; gap: 40px; z-index: 20;
        }
        .action-big {
            width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); transition: transform 0.2s;
        }
        .action-big:active { transform: scale(0.9); }
        .btn-like { background: #10B981; color: white; }
        .btn-next { background: #EF4444; color: white; }

        /* PROFILE INFO */
        .match-info {
            position: absolute; bottom: 120px; left: 20px; z-index: 15;
            text-shadow: 0 2px 5px black;
        }
        .match-name { font-size: 24px; font-weight: bold; }
        .match-sub { font-size: 14px; color: #ccc; }

        /* WAITING OVERLAY */
        #waiting-overlay {
            position: absolute; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .pulse-ring {
            width: 80px; height: 80px; border: 4px solid var(--accent); border-radius: 50%;
            animation: ringOut 2s infinite; margin-bottom: 20px;
        }
        @keyframes ringOut { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFmhk3ybnsVsFenCE3xvdmy5y_4u9ss7o", 
            authDomain: "playgroundx-ca021.firebaseapp.com",
            projectId: "playgroundx-ca021",
            storageBucket: "playgroundx-ca021.firebasestorage.app",
            messagingSenderId: "427340828971",
            appId: "1:427340828971:web:1d9e2dc22ecd69593eb56e"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const APP_ID = "playgroundX_Prod_v1";

        

        // --- MATCHING ENGINE ---
        async function findMatch() {
            try {
                // Fetch public users
                const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
                const snap = await getDocs(usersRef);
                const candidates = [];
                
                snap.forEach(doc => {
                    if (doc.id !== uid) candidates.push(doc.data());
                });

                if (candidates.length > 0) {
                    // Pick Random Candidate
                    const match = candidates[Math.floor(Math.random() * candidates.length)];
                    displayMatch(match);
                } else {
                    alert("No matches online. Try again later.");
                    window.location.href = "home.html";
                }
            } catch (e) {
                console.error("Match Error", e);
            }
        }

        function displayMatch(user) {
            document.getElementById('waiting-overlay').style.display = 'none';
            document.getElementById('match-name').innerText = user.alias + ", " + user.age;
            // In a real app, this would initiate WebRTC. For now, we simulate the video start.
            document.getElementById('remote-video').play();
            startTimer();
        }

        // --- TIMER ---
        function startTimer() {
            let timeLeft = 180; // 3 minutes
            const timerEl = document.getElementById('round-timer');
            
            const interval = setInterval(() => {
                timeLeft--;
                let m = Math.floor(timeLeft / 60);
                let s = (timeLeft % 60).toString().padStart(2, '0');
                timerEl.innerText = `0${m}:${s}`;
                
                if (timeLeft < 10) timerEl.classList.add('urgent');
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    alert("Date Ended! Redirecting to Lounge.");
                    window.location.href = "home.html";
                }
            }, 1000);
        }

        // --- INIT ---
        window.onload = () => {
            // Start Local Camera
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true })
                .then(stream => document.getElementById('local-video').srcObject = stream);
            
            // Find Match after 2 seconds
            setTimeout(findMatch, 2000);
        }

        // --- CONTROLS ---
        window.handleAction = (action) => {
            if (action === 'like') alert("Liked! We'll let them know.");
            window.location.href = "home.html"; // End date after action
        }
    </script>
</head>
<body>

    <div id="waiting-overlay">
        <div class="pulse-ring"></div>
        <div style="color:white; font-weight:bold; letter-spacing:1px;">CONNECTING...</div>
    </div>

    <div id="stage">
        <video id="remote-video" src="https://www.w3schools.com/html/mov_bbb.mp4" loop muted playsinline></video>
        
        <div id="local-video-container">
            <video id="local-video" autoplay muted playsinline></video>
        </div>

        <div class="hud-top">
            <div style="font-weight:bold; color:#aaa;">LIVE DATE</div>
            <div class="timer-main" id="round-timer">03:00</div>
            <button onclick="window.location.href='home.html'" style="background:none; border:none; color:white; font-size:24px;">‚úï</button>
        </div>

        <div class="match-info">
            <div class="match-name" id="match-name">Finding Match...</div>
            <div class="match-sub">Local ‚Ä¢ Verified</div>
        </div>

        <div class="hud-bottom">
            <button class="action-big btn-next" onclick="window.handleAction('next')">üëé</button>
            <button class="action-big btn-like" onclick="window.handleAction('like')">‚ù§Ô∏è</button>
        </div>
    </div>

</body>
</html>

